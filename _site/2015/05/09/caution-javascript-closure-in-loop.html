<!DOCTYPE html>
  <html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Caution Javascript Closure in Loop</title>
  </head>
  <body>

	<!-- blog comment goes here -->
    <h1 id="caution-javascript-closure-in-loop">Caution Javascript Closure in Loop</h1>

<h3 id="object">Object</h3>
<p>Define a function <span style="background-color:yellow;"><em>addTimer</em></span>, to log executed time for all function-type property of an object</p>

<h3 id="definition-1">Definition 1</h3>

<h4 id="code">Code:</h4>
<pre><code>var addTimer = function (widget) {
	var prop;
	for (prop in widget) {
		if (typeof widget[prop] === 'function') {
			var backupFunc = widget[prop];
			// the same problem with the following code
			//backupFunc = (function () {
			//	return widget[prop];
			//})();
			
			// try a deep copy here to make bakcupFunc not changed with prop
			widget[prop] = function () {
				console.time("from timer " + prop);
				backupFunc.apply(this, arguments);
				console.timeEnd("from timer " + prop);
			};
			// the same problem with the following code
			//widget[prop] = (function () {
			//	return function () {
			//		console.time(prop);
			//		backupFunc.apply(this, arguments);
			//		console.timeEnd(prop);
			//	};
			//})();
		}
	}
}
</code></pre>

<h4 id="problem">Problem</h4>
<p>All function type property in widget will call the last function type property</p>

<h3 id="definition-2">Definition 2</h3>
<p>Since there is no block scope in JavaScript - only <strong>function scope</strong> - by wrapping the function creation in a new function, you ensure that the value of <code>prop</code> remains as you intended.</p>

<h4 id="code-1">Code:</h4>
<pre><code>var addTimer = function (widget) {
    var prop;
    var getFuncWithTimer = function (prop) {
        return function () {
            console.time("from timer " + prop);
            widget[prop].apply(this, arguments);
            console.timeEnd("from timer " + prop);
        };
    };
    for (prop in widget) {
        if (typeof widget[prop] === 'function') {
            widget[prop] = getFuncWithTimer(prop);
        }

    }
};
</code></pre>

<h4 id="problem-1">Problem</h4>
<p>exceed maximum call stack</p>

<h3 id="definition-3">Definition 3</h3>

<h4 id="code-2">Code:</h4>
<pre><code>var addTimer = function (widget) {
    var prop;
    var getFuncWithTimer = function (prop) {
		var backupFunc = widget[prop];
        return function () {
            console.time("from timer " + prop);
            backupFunc.apply(this, arguments);
            console.timeEnd("from timer " + prop);
        };
    };
    for (prop in widget) {
        if (typeof widget[prop] === 'function') {
            widget[prop] = getFuncWithTimer(prop);
        }

    }
};
</code></pre>

<h4 id="problem-2">Problem</h4>
<p>All function with returned value can not work</p>

<h3 id="final-definition">Final Definition</h3>

<h4 id="code-3">Code:</h4>
<pre><code>var addTimer = function (widget) {
    var prop;
    var getFuncWithTimer = function (prop) {
		var backupFunc = widget[prop];
        return function () {
            console.time("from timer " + prop);
            var ret = backupFunc.apply(this, arguments);
            console.timeEnd("from timer " + prop);
			return ret;
        };
    };
    for (prop in widget) {
        if (typeof widget[prop] === 'function') {
            widget[prop] = getFuncWithTimer(prop);
        }

    }
};
</code></pre>

	
	<!-- disqus comment goes here -->
	
<!-- track pages with comments is true in the YAML part of it -->


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // Required: on line below, replace text in quotes with your forum shortname
    var disqus_shortname = 'hongchaozhang';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

	
	<!-- for google analytics -->
	
<!-- track the access of every page -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62806905-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
  </html>